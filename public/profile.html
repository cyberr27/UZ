<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Профіль користувача</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/css/style.css" />
    <style>
      body {
        background-color: #f3f4f6;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
      }
      .profile-container {
        background: rgba(255, 255, 255, 0.95);
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        width: 90%;
        max-width: 500px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div
      class="profile bg-white p-8 rounded-lg shadow-lg w-[80%] mx-[10%] animate__animated animate__fadeIn"
    >
      <h2 id="my-userProfileText" class="text-2xl font-bold mb-6 text-center">
        Профіль користувача
      </h2>
      <div class="text-center">
        <div class="relative mx-auto w-16 h-16">
          <img
            id="profile-photo"
            class="w-16 h-16 rounded-full object-cover hidden"
            alt="Profile Photo"
          />
          <div
            id="profile-photo-placeholder"
            class="w-16 h-16 rounded-full bg-gray-300 flex items-center justify-center text-white font-bold text-lg"
          ></div>
        </div>
        <p id="my-lN" class="mt-4"><strong>Прізвище:</strong></p>
        <p id="profile-lastName" class="text-gray-600"></p>
        <p id="my-fN" class="mt-2"><strong>Ім'я:</strong></p>
        <p id="profile-firstName" class="text-gray-600"></p>
        <p id="my-mN" class="mt-2"><strong>По батькові:</strong></p>
        <p id="profile-middleName" class="text-gray-600"></p>
        <p id="my-pp" class="mt-2"><strong>Посада:</strong></p>
        <p id="profile-position" class="text-gray-600"></p>
        <p id="mt-peId" class="mt-2"><strong>Табельний номер:</strong></p>
        <p id="profile-employeeId" class="text-gray-600"></p>
        <p id="my-pwId" class="mt-2"><strong>ID працівника:</strong></p>
        <p id="profile-workerId" class="text-gray-600"></p>
        <button
          id="close-profile"
          class="mt-4 bg-gray-500 text-white p-2 rounded hover:bg-gray-600 transition"
        >
          Закрити
        </button>
      </div>
      <script>
        document.addEventListener("DOMContentLoaded", async () => {
          // Получаем параметры из URL
          const urlParams = new URLSearchParams(window.location.search);
          const workerId = urlParams.get("workerId");
          const token = urlParams.get("token");

          if (!workerId || !token) {
            alert("Недостатньо даних для завантаження профілю");
            window.close();
            return;
          }

          try {
            const response = await fetch(`/api/auth/user/${workerId}`, {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
            });
            const data = await response.json();
            if (response.ok) {
              const user = data.user;
              // Заполнение данных профиля
              document.getElementById("profile-lastName").textContent =
                user.lastName || "Не вказано";
              document.getElementById("profile-firstName").textContent =
                user.firstName || "Не вказано";
              document.getElementById("profile-middleName").textContent =
                user.middleName || "Не вказано";
              document.getElementById("profile-position").textContent =
                user.position || "Не вказано";
              document.getElementById("profile-employeeId").textContent =
                user.employeeId || "Не вказано";
              document.getElementById("profile-workerId").textContent =
                user.workerId || "Не вказано";

              // Обновление фото профиля или заглушки
              const photo = document.getElementById("profile-photo");
              const placeholder = document.getElementById(
                "profile-photo-placeholder"
              );
              if (user.photo) {
                const photoUrl = `${user.photo}?t=${Date.now()}`;
                photo.src = photoUrl;
                photo.classList.remove("hidden");
                placeholder.classList.add("hidden");
                photo.onerror = () => {
                  console.error(
                    `Помилка завантаження зображення: ${photoUrl}. Перевірте URL Cloudinary`
                  );
                  const initials = `${user.firstName?.charAt(0) || ""}${
                    user.lastName?.charAt(0) || ""
                  }`.toUpperCase();
                  placeholder.textContent = initials || "НВ";
                  placeholder.classList.remove("hidden");
                  photo.classList.add("hidden");
                };
              } else {
                const initials = `${user.firstName?.charAt(0) || ""}${
                  user.lastName?.charAt(0) || ""
                }`.toUpperCase();
                placeholder.textContent = initials || "НВ";
                placeholder.classList.remove("hidden");
                photo.classList.add("hidden");
              }
            } else {
              alert(data.error || "Помилка завантаження профілю");
              window.close();
            }
          } catch (error) {
            console.error("Помилка завантаження профілю:", error);
            alert("Помилка завантаження профілю: " + error.message);
            window.close();
          }

          // Закрытие вкладки по кнопке
          document
            .getElementById("close-profile")
            .addEventListener("click", () => {
              window.close();
            });
        });
      </script>
    </div>
  </body>
</html>
